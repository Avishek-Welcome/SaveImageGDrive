<!DOCTYPE html>
<html>
<head>
  <style>
    /* Add your CSS styling here */
  </style>
</head>
<body>
  <h1>Student Photo Capture</h1>
  
  <!-- Sheet Selection -->
  <select id="sheetSelect" onchange="loadRollNumbers()">
    <option value="">Select Sheet</option>
  </select>

  <!-- Roll Number Selection -->
  <select id="rollSelect" onchange="loadStudentDetails()">
    <option value="">Select Roll No</option>
  </select>

  <!-- Student Info Display -->
  <div id="studentInfo"></div>

  <!-- Camera Preview -->
  <video id="video" width="320" height="240" autoplay></video>
  <button onclick="capturePhoto()">Capture Photo</button>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <!-- Preview and Save -->
  <div id="preview"></div>
  <button onclick="savePhoto()" style="display:none;" id="saveBtn">Save to Drive</button>

  <script>
    let studentCode = null;
    let capturedImage = null;

    // Load sheets on startup
    google.script.run.withSuccessHandler(sheets => {
      const sheetSelect = document.getElementById('sheetSelect');
      sheets.forEach(sheet => {
        const option = document.createElement('option');
        option.value = sheet;
        option.text = sheet;
        sheetSelect.add(option);
      });
    }).getSheetNames();

    // Load roll numbers when sheet is selected
    function loadRollNumbers() {
      const sheet = document.getElementById('sheetSelect').value;
      google.script.run.withSuccessHandler(rollNos => {
        const rollSelect = document.getElementById('rollSelect');
        rollSelect.innerHTML = '<option value="">Select Roll No</option>';
        rollNos.forEach(roll => {
          const option = document.createElement('option');
          option.value = roll;
          option.text = roll;
          rollSelect.add(option);
        });
      }).getRollNumbers(sheet);
    }

    // Load student details
    function loadStudentDetails() {
      const sheet = document.getElementById('sheetSelect').value;
      const rollNo = document.getElementById('rollSelect').value;
      google.script.run.withSuccessHandler(details => {
        document.getElementById('studentInfo').innerHTML = 
          `Student Code: ${details.code}<br>Name: ${details.name}`;
        studentCode = details.code;
        initializeCamera();
      }).getStudentDetails(sheet, rollNo);
    }

    // Initialize camera
    function initializeCamera() {
      navigator.mediaDevices.getUserMedia({ video: { aspectRatio: 5/6.5 } })
        .then(stream => {
          document.getElementById('video').srcObject = stream;
        })
        .catch(err => console.error('Camera access denied:', err));
    }

    // Capture photo
    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas dimensions to 5:6.5 ratio (e.g., 500x650)
      canvas.width = 500;
      canvas.height = 650;
      
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      capturedImage = canvas.toDataURL('image/jpeg');
      document.getElementById('saveBtn').style.display = 'block';
    }

    // Save photo to Drive
    function savePhoto() {
      const imageData = capturedImage.split(',')[1];
      google.script.run.withSuccessHandler(url => {
        alert(`Photo saved successfully: ${url}`);
      }).saveToDrive(studentCode, imageData);
    }
  </script>
</body>
</html>
