<script>
  const scriptUrl = 'https://script.google.com/macros/s/AKfycbwLc6lGO6M7jZLfA-fEf1QINPIzKeX0RDqQ4rBYR6FveJRa9EduYixJ8IfbuUSXHyxh/exec';
  let students = [];
  let currentStream;
  let useFrontCamera = true;

  async function loadSheets() {
    try {
      const res = await fetch(scriptUrl);
      const sheetNames = await res.json();
      const select = document.getElementById('sheetSelect');
      select.innerHTML = '<option value="">--Select Class & Section--</option>';
      sheetNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
    } catch (err) {
      console.error("Failed to load sheets:", err);
      document.getElementById('sheetSelect').innerHTML = '<option value="">‚ö†Ô∏è Failed to load</option>';
    }
  }

  async function loadRolls(sheetName) {
    const form = new FormData();
    form.append('action', 'getStudents');
    form.append('sheetName', sheetName);
    const res = await fetch(scriptUrl, { method: 'POST', body: form });
    students = await res.json();
    const rollSelect = document.getElementById('rollSelect');
    rollSelect.innerHTML = '<option value="">--Select Roll No--</option>';
    students.forEach(st => {
      const opt = document.createElement('option');
      opt.value = st.roll;
      opt.textContent = st.roll;
      rollSelect.appendChild(opt);
    });
    // Reset student info
    updateStudentInfo('');
  }

  function updateStudentInfo(roll) {
    const student = students.find(s => s.roll === roll);
    const name = student ? student.name : '';
    const code = student ? student.code : '';
    document.getElementById('studentName').textContent = `üë§ Name: ${name}`;
    document.getElementById('studentCode').textContent = `üÜî Code: ${code}`;
    if (code) {
      showStudentImage(code);
    } else {
      document.getElementById('studentImage').style.display = 'none';
    }
  }

  async function showStudentImage(code) {
    const form = new FormData();
    form.append('action', 'getImageIdByCode');
    form.append('code', code);

    const res = await fetch(scriptUrl, { method: 'POST', body: form });
    const result = await res.json();

    const img = document.getElementById('studentImage');
    if (result.status === 'found') {
      img.src = `https://drive.google.com/uc?export=view&id=${result.fileId}`;
      img.style.display = 'block';
    } else {
      img.style.display = 'none';
    }
  }

  function captureImage() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvasPreview');
    const ctx = canvas.getContext('2d');
    const { videoWidth, videoHeight } = video;

    const targetRatio = 300 / 390;
    const actualRatio = videoWidth / videoHeight;

    let sx, sy, sWidth, sHeight;
    if (actualRatio > targetRatio) {
      sHeight = videoHeight;
      sWidth = sHeight * targetRatio;
      sx = (videoWidth - sWidth) / 2;
      sy = 0;
    } else {
      sWidth = videoWidth;
      sHeight = sWidth / targetRatio;
      sx = 0;
      sy = (videoHeight - sHeight) / 2;
    }

    ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, 300, 390);
    canvas.style.display = 'block';
  }

  async function uploadImage() {
    const canvas = document.getElementById('canvasPreview');
    const roll = document.getElementById('rollSelect').value;
    const sheetName = document.getElementById('sheetSelect').value;
    const student = students.find(s => s.roll === roll);
    if (!student || !canvas.toDataURL || !sheetName) {
      document.getElementById('status').textContent = '‚ö†Ô∏è Please select Class, Roll No, and capture image.';
      return;
    }

    document.getElementById('status').textContent = '‚è≥ Uploading...';

    const dataUrl = canvas.toDataURL('image/jpeg');
    const base64 = dataUrl.split(',')[1];

    const form = new FormData();
    form.append('action', 'uploadImage');
    form.append('sheetName', sheetName);
    form.append('code', student.code);
    form.append('image', base64);
    form.append('mimeType', 'image/jpeg');

    const res = await fetch(scriptUrl, { method: 'POST', body: form });
    const result = await res.json();

    if (result.status === 'success') {
      document.getElementById('status').textContent = '‚úÖ Image uploaded successfully!';
      document.getElementById('thankYouAudio').play();
      showStudentImage(student.code); // Reload preview
      setTimeout(() => window.close(), 3000);
    } else {
      document.getElementById('status').textContent = '‚ùå Upload failed: ' + result.message;
    }
  }

  async function startCamera() {
    if (currentStream) {
      currentStream.getTracks().forEach(track => track.stop());
    }
    const constraints = {
      video: {
        facingMode: useFrontCamera ? 'user' : 'environment'
      }
    };
    currentStream = await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById('video').srcObject = currentStream;
  }

  function swapCamera() {
    useFrontCamera = !useFrontCamera;
    startCamera();
  }

  document.getElementById('sheetSelect').addEventListener('change', e => loadRolls(e.target.value));
  document.getElementById('rollSelect').addEventListener('change', e => updateStudentInfo(e.target.value));

  loadSheets();
  startCamera();
</script>
