<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      video, canvas {
        width: 500px;
        height: 650px;
        border: 1px solid black;
      }
    </style>
  </head>
  <body>
    <h1>Student Photo Upload</h1>
    <label for="sheetSelect">Select Sheet:</label>
    <select id="sheetSelect"></select>
    <br><br>
    <label for="rollSelect">Select Roll No:</label>
    <select id="rollSelect"></select>
    <br><br>
    <p id="studentName"></p>
    <video id="video" autoplay></video>
    <br>
    <button id="capture">Capture</button>
    <canvas id="canvas" style="display:none;"></canvas>
    <br>
    <button id="upload">Upload</button>
    <p id="status"></p>

    <script>
      let studentCode = '';

      function populateSheets() {
        google.script.run.withSuccessHandler(function(sheets) {
          const sheetSelect = document.getElementById('sheetSelect');
          sheets.forEach(sheet => {
            const option = document.createElement('option');
            option.value = sheet;
            option.text = sheet;
            sheetSelect.add(option);
          });
        }).getSheetNames();
      }

      function populateRollNumbers(sheetName) {
        google.script.run.withSuccessHandler(function(rolls) {
          const rollSelect = document.getElementById('rollSelect');
          rollSelect.innerHTML = '';
          rolls.forEach(roll => {
            const option = document.createElement('option');
            option.value = roll;
            option.text = roll;
            rollSelect.add(option);
          });
        }).getRollNumbers(sheetName);
      }

      function fetchStudentInfo(sheetName, rollNo) {
        google.script.run.withSuccessHandler(function(info) {
          document.getElementById('studentName').innerText = `Student Name: ${info.name}`;
          studentCode = info.code;
        }).getStudentInfo(sheetName, rollNo);
      }

      document.getElementById('sheetSelect').addEventListener('change', function() {
        const sheetName = this.value;
        populateRollNumbers(sheetName);
      });

      document.getElementById('rollSelect').addEventListener('change', function() {
        const sheetName = document.getElementById('sheetSelect').value;
        const rollNo = this.value;
        fetchStudentInfo(sheetName, rollNo);
      });

      // Access the device camera and stream to video element
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          document.getElementById('video').srcObject = stream;
        })
        .catch(err => {
          console.error("Error accessing camera: ", err);
        });

      // Capture the image from the video stream
      document.getElementById('capture').addEventListener('click', () => {
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        context.drawImage(document.getElementById('video'), 0, 0, canvas.width, canvas.height);
        canvas.style.display = 'block';
      });

      // Upload the captured image to Google Drive
      document.getElementById('upload').addEventListener('click', () => {
        if (!studentCode) {
          alert('Please select a student.');
          return;
        }

        const canvas = document.getElementById('canvas');
        const imageData = canvas.toDataURL('image/jpeg');
        const payload = {
          imageData,
          studentCode
        };

        google.script.run.withSuccessHandler(function(response) {
          if (response.status === 'success') {
            document.getElementById('status').innerText = 'Image uploaded successfully!';
          } else {
            document.getElementById('status').innerText = 'Upload failed: ' + response.message;
          }
        }).uploadImage(payload);
      });

      // Initialize the sheet selection on page load
      window.onload = function() {
        populateSheets();
      };
    </script>
  </body>
</html>
